/*
 * LazyJSON Plugin
 * Version: 1.1.0 (Wed, 12 Dec 2012)
 * https://github.com/rpnzl/jquery-lazyjson
 *
 * Copyright 2012, Michael Giuliana
 * http://rpnzl.com
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */
(function(b,a,c){c.fn.lazyjson=function(e){var l=this,o=null,m=null,g=null,h=["lazyLoad","nextBtn","custom"],p=["prevBtn"],n=null,d=false,k=false,j={},f=null,i=null,q,r=c.extend(true,{},c.fn.lazyjson.defaults,e);l.init=function(){l.checkOpts();if(r.loadOnInit){l.load(true)}if(r.pagination.active){if(r.pagination.lazyLoad){c(b).scroll(function(){var s=l.position();if((c(b).height()+c(b).scrollTop())>(s.top+l.height())){n="lazyLoad";l.load()}})}else{if(r.pagination.loadOnEvent&&r.pagination.loadOnTarget){c("body").on(r.pagination.loadOnEvent,r.pagination.loadOnTarget,function(s){s.preventDefault();n="custom";l.load()})}else{c(l.parent()).on("click",r.pagination.nextBtn,function(s){s.preventDefault();n="nextBtn";l.load()});c(l.parent()).on("click",r.pagination.prevBtn,function(s){s.preventDefault();n="prevBtn";l.load()})}}}};l.debug=function(s,t,u){if(a&&a.log){if(r.debug&&s&&t&&u){a.log({name:s,type:t,data:u})}}};l.checkOpts=function(){if(!c("#"+r.templatePrefix+c(l).attr("id")).length){l.debug("templateNotFound","error","The template object was not found.")}else{q=c("#"+r.templatePrefix+c(l).attr("id"),l).clone().removeAttr("id").removeAttr("style");c("#"+r.templatePrefix+c(l).attr("id")).remove()}if(!(r.loader instanceof jQuery)){r.loader=c(r.loader);r.loader.children("img").attr("src",r.loaderImg)}if(!(r.noResults instanceof jQuery)){r.noResults=c(r.noResults).text(r.noResultsText)}if(!r.api.uri){l.debug("invalidApiUri","error","Please provide an API endpoint in options.api.uri .")}if(!r.api.httpMethod||c.inArray(r.api.httpMethod,["GET","POST"])===-1){l.debug("invalidHttpMethod","error","Please provide a valid HTTP method.")}};l.load=function(s){if(!d){d=true;if(!r.pagination.appendResults&&n!=="lazyLoad"||c.inArray(n,["nextBtn","prevBtn"])!==-1){c(".lazyjson-template",l).remove()}if(c.inArray(n,h)!==-1&&k===false){o+=1}else{if(c.inArray(n,p)!==-1){o-=1}else{l.debug("currEvent","error","The event is not defined in pagination settings.")}}l.debug("currEvent","notice",n);l.loader(true);j=c.extend(true,j,c(l).data(),r.api.params);if(r.pagination.active){if(o<=0){o=1}if(s){o=1;m=r.pagination.pages*r.pagination.count;g=(o-1)*m}else{o=o||1;m=m||r.pagination.count;g=(o-1)*m}if(r.api.pagination){j[r.api.pagesKey]=o;j[r.api.limitKey]=m;j[r.api.offsetKey]=g}}l.debug("pagination","notice",{page:o,count:m,offset:g});c.ajax({type:r.api.httpMethod.toUpperCase(),url:r.api.uri,data:j,dataType:l.getDataType()}).done(function(v){if(v){if(r.api.dataPos){var u=r.api.dataPos.split(".");for(var t=0;t<u.length;t++){v=v[u[t]]}}f=v;if(r.pagination.active&&!r.api.pagination){f=f.slice(g,g+m)}if(f.length===0){k=true;l.append(r.noResults)}else{k=false;r.noResults.remove();l.build(f)}}if(s){o=r.pagination.pages;m=r.pagination.count}}).fail(function(t,u){}).always(function(){l.loader(false);setTimeout(function(){d=false},800);r.afterLoad(f)})}};l.build=function(s){if(typeof s!=="object"){l.debug("invalidJSON","error","The response must be a valid JSON object.");if(typeof s==="string"){c(l.append("<p>"+s+"</p>"))}}else{if(r.debug){l.debug("response","notice",s)}c.each(s,function(u,t){i=t;var x=q.clone(),w=l.parseObj(x.html(),t);x.html(w).addClass("lazyjson-template").appendTo(l);if(r.effect!==null){x.hide();setTimeout(function(){if(r.effect==="fadeIn"){x.fadeIn("fast")}else{if(r.effect==="slideDown"){x.slideDown("fast")}}},r.delay*u)}})}};l.extractVal=function(u,s){if(s.indexOf(".")!==-1){var t=s.split(".")[0],s=s.slice(t.length+1,s.length);return l.extractVal(u[t],s)}else{if(u!==null&&typeof u[s]!=="undefined"){return u[s]}else{return false}}};l.parseFlag=function(v){var x=v.split(" ")[0].replace(/[{{|}}]/gm,""),y=l.extractVal(i,x),u=v.match(/(\w+)(?=\=)|\s*?[\"\']([^\"\']+)[\"\']/gm)||[],t={};for(var w=0;w<=u.length-2;w++){t[u[w]]=u[w+1].replace(/['"]/gm,"");w++}if(t.ifVal&&t.ifVal.indexOf(y)!==-1){var z=t.ifVal.split(",");for(var w=0;w<z.length;w++){var s=z[w].split("::");if(y==s[0]){return s[1]}}}else{if(t.exists&&y!==false){a.log(x+" exists: "+y);return t.exists}else{if(t.empty&&y===false){return t.empty}else{return y===0?"0":y||v}}}};l.parseObj=function(s,t){if(typeof t==="object"){s=s.replace(/\{\{\s*(\w[^\}\s]*)(.*?)\s*\}\}/gm,l.parseFlag)}else{if(typeof t==="string"){s=s.replace(/\{\{value\}\}/gm,t)}}return s};l.getDataType=function(){var t=document.createElement("a"),s=document.createElement("a");t.href=document.URL;s.href=r.api.uri;if(s.hostname===t.hostname&&!r.api.forceJSONP){a.log("json");return"json"}else{a.log(s.hostname);a.log(t.hostname);a.log("jsonp");return"jsonp"}};l.loader=function(s){if(s){l.append(r.loader)}else{c(r.loader,l).remove()}};if(c(this).length!==0){l.init();l.debug("options","notice",r)}else{l.debug("invalidMainElement","error","The main object "+this+" does not exist.")}};c.fn.lazyjson.defaults={loadOnInit:true,templatePrefix:"template-",loader:'<div id="lj-loader" style="text-align:center;padding:20px;"><img /></div>',loaderImg:null,noResults:'<div id="lj-noresponse" style="text-align:center;padding:20px;"></div>',noResultsText:"No Results Found",delay:50,effect:null,pagination:{active:false,pages:1,count:10,appendResults:false,lazyLoad:false,nextBtn:"a.next",prevBtn:"a.previous",loadOnEvent:null,loadOnTarget:null},api:{uri:null,httpMethod:"GET",forceJSONP:false,dataPos:false,pagination:false,pagesKey:"page",limitKey:"limit",offsetKey:"offset",params:{}},debug:false,afterLoad:function(d){}}})(window,console,jQuery);
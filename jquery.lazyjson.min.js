/*!
 * lazyJSON - jQuery Plugin
 * version: 1.0.0 (Wed, 10 Oct 2012)
 *
 * Copyright 2012 Michael Giuliana - michael.giuliana@gmail.com
 *
 */
(function(b,a,c){c.fn.lazyjson=function(e){var i=this,l=null,j=null,f=null,g=["lazyLoad","nextBtn","custom"],m=["prevBtn"],k=null,d=false,h={},n,o=c.extend(true,{},c.fn.lazyjson.defaults,e);i.init=function(){i.checkOpts();if(o.loadOnInit){i.load(true)}if(o.pagination.active){if(o.pagination.lazyLoad){c(b).scroll(function(){var p=i.position();if((c(b).height()+c(b).scrollTop())>(p.top+i.height())){k="lazyLoad";i.load()}})}else{c(i.parent()).on("click",o.pagination.nextBtn,function(p){p.preventDefault();c(".lazyjson-template",i).remove();k="nextBtn";i.load()});c(i.parent()).on("click",o.pagination.prevBtn,function(p){p.preventDefault();c(".lazyjson-template",i).remove();k="prevBtn";i.load()});if(o.pagination.loadOnEvent&&o.pagination.loadOnTarget){c("body").on(o.pagination.loadOnEvent,"#"+o.pagination.loadOnTarget,function(p){p.preventDefault();if(!o.pagination.appendResults){c(".lazyjson-template",i).remove()}k="custom";i.load()})}}}};i.debug=function(p,q,r){if(a&&a.log){if(o.debug&&p&&q&&r){a.log({name:p,type:q,data:r})}}};i.checkOpts=function(){if(!c(o.childEl+"#"+o.templatePrefix+c(i).attr("id")).length){i.debug("templateNotFound","error","The template object was not found.")}else{n=c(o.childEl+"#"+o.templatePrefix+c(i).attr("id")).clone().removeAttr("id").removeAttr("style");c("#"+o.templatePrefix+c(i).attr("id")).remove()}if(!o.api.uri){i.debug("invalidApiUri","error","Please provide an API endpoint in options.api.uri .")}if(!o.api.httpMethod||c.inArray(o.api.httpMethod,["GET","POST"])===-1){i.debug("invalidHttpMethod","error","Please provide a valid HTTP method.")}o.loader=c(o.loader);o.loader.children("img").attr("src",o.loaderImg)};i.load=function(p){if(!d){d=true;if(c.inArray(k,g)!==-1){l+=1}else{if(c.inArray(k,m)!==-1){l-=1}else{i.debug("currEvent","error","The event is not defined in pagination settings.")}}i.debug("currEvent","notice",k);i.loader(true);h=c.extend(true,h,c(i).data(),o.params);if(o.pagination.active){if(p){l=1;j=o.pagination.pages*o.pagination.count;f=(l-1)*j}else{l=l||1;j=j||o.pagination.count;f=(l-1)*j}if(o.api.pagination){h[o.api.pagesKey]=l;h[o.api.limitKey]=j;h[o.api.offsetKey]=f}}i.debug("pagination","notice",{page:l,count:j,offset:f});c.ajax({type:o.api.httpMethod.toUpperCase(),url:o.api.uri,data:h}).done(function(q){q=c.parseJSON(q);if(q){if(o.pagination.active&&!o.api.pagination){q=q.slice(f,f+j)}i.build(q)}if(p){l=o.pagination.pages;j=o.pagination.count}}).always(function(){i.loader(false);setTimeout(function(){d=false},1000);o.afterLoad()})}};i.build=function(p){if(typeof p!=="object"){i.debug("error","The response must be a valid JSON object.");if(typeof p==="string"){c(i.append("<p>"+p+"</p>"))}}else{c.each(p,function(r,q){var t=n.clone(),s=i.parseObj(t.html(),q);c(i).append(t.html(s).addClass("lazyjson-template").hide().delay(o.delay*r).fadeIn("fast")).stop()})}};i.parseObj=function(q,r,p){if(p){p=p+"."}else{p=""}if(typeof r==="object"){c.each(r,function(t,s){if(s===null){s=""}if(typeof s==="object"){q=i.parseObj(q,s,p+t)}else{var u=new RegExp("{{"+p+t+"}}","g");q=q.replace(u,s)}})}return q};i.loader=function(p){if(p){i.append(o.loader)}else{c(o.loader,i).remove()}};if(c(this).length!==0){i.init()}else{i.debug("invalidMainElement","error","The main object "+this+" does not exist.")}};c.fn.lazyjson.defaults={childEl:"div",templatePrefix:"template-",debug:false,loadOnInit:true,loader:'<div id="lj-loader" style="text-align:center;padding:20px;"><img /></div>',loaderImg:null,delay:50,pagination:{active:false,pages:1,count:10,appendResults:false,lazyLoad:false,nextBtn:"a.next",prevBtn:"a.previous",loadOnEvent:null,loadOnTarget:null},api:{uri:null,httpMethod:"GET",pagination:false,pagesKey:"page",limitKey:"limit",offsetKey:"offset",params:null},afterLoad:function(){},beforeLoad:function(){}}})(window,console,jQuery);
/*
 * LazyJSON Plugin
 * Version: 1.1 (Wed, 12 Dec 2012)
 * https://github.com/rpnzl/jquery-lazyjson
 *
 * Copyright 2012, Michael Giuliana
 * http://rpnzl.com
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */
(function(b,a,c){c.fn.lazyjson=function(g){var o=this,q=null,p=null,i=null,j=["lazyLoad","nextBtn","custom"],r=["prevBtn"],d=[],n=null,f=false,m=false,l={},e=null,h=null,k=null,s,t=c.extend(true,{},c.fn.lazyjson.defaults,g);o.init=function(){o.checkOpts();if(t.loadOnInit){o.load(true)}if(t.pagination.active){if(t.pagination.lazyLoad){d.push({targ:"window",evt:"scroll"});c(b).scroll(function(){var u=o.position();if((c(b).height()+c(b).scrollTop())>(u.top+o.height())){n="lazyLoad";o.load()}})}else{if(t.pagination.loadOnEvent&&t.pagination.loadOnTarget){d.push({targ:t.pagination.loadOnTarget,evt:t.pagination.loadOnEvent});c("body").on(t.pagination.loadOnEvent,t.pagination.loadOnTarget,function(u){u.preventDefault();n="custom";o.load()})}else{d.push({targ:t.pagination.nextBtn,evt:"click"});c(o.parent()).on("click",t.pagination.nextBtn,function(u){u.preventDefault();n="nextBtn";o.load()});d.push({targ:t.pagination.prevBtn,evt:"click"});c(o.parent()).on("click",t.pagination.prevBtn,function(u){u.preventDefault();n="prevBtn";o.load()})}}}o.debug("boundEvents","notice",d)};o.debug=function(u,v,w){if(a&&a.log){if(t.debug&&u&&v&&w){a.log({name:u,type:v,data:w})}}};o.checkOpts=function(){if(!c("#"+t.templatePrefix+c(o).attr("id")).length){o.debug("templateNotFound","error","The template object was not found.")}else{s=c("#"+t.templatePrefix+c(o).attr("id"),o).clone().removeAttr("id").removeAttr("style");c("#"+t.templatePrefix+c(o).attr("id")).remove()}if(!(t.loader instanceof jQuery)){t.loader=c(t.loader);t.loader.find("img").attr("src",t.loaderImg)}if(!(t.noResults instanceof jQuery)){t.noResults=c(t.noResults).html(t.noResultsText)}if(!t.api.uri){o.debug("invalidApiUri","error","Please provide an API endpoint in options.api.uri .")}if(!t.api.httpMethod||c.inArray(t.api.httpMethod,["GET","POST"])===-1){o.debug("invalidHttpMethod","error","Please provide a valid HTTP method.")}if(!t.api.whichPagVars){t.api.whichPagVars=["page","limit","offset"]}};o.load=function(u){if(!f){f=true;if(!t.pagination.appendResults&&n!=="lazyLoad"||c.inArray(n,["nextBtn","prevBtn"])!==-1){c(".lazyjson-template",o).remove()}if(c.inArray(n,j)!==-1&&m===false){q+=1}else{if(c.inArray(n,r)!==-1){q-=1}else{o.debug("currEvent","error","The event is not defined in pagination settings.")}}o.debug("currEvent","notice",n);o.loader(true);l=c.extend(true,l,t.api.params);if(t.pagination.active){if(q<=0){q=1}if(u){q=1;p=t.pagination.pages*t.pagination.count;i=(q-1)*p}else{q=q||1;p=p||t.pagination.count;i=(q-1)*p}if(t.api.pagination&&t.api.pagVars){if(c.inArray("page",t.api.whichPagVars)!==-1){l[t.api.pagesKey]=q}if(c.inArray("limit",t.api.whichPagVars)!==-1){l[t.api.limitKey]=p}if(c.inArray("offset",t.api.whichPagVars)!==-1){l[t.api.offsetKey]=i}}}o.debug("pagination","notice",{page:q,count:p,offset:i});c.ajax({type:t.api.httpMethod.toUpperCase(),url:t.api.uri,data:l,dataType:o.getDataType()}).done(function(x){if(x){e=x;if(t.api.dataPos){var w=t.api.dataPos.split(".");for(var v=0;v<w.length;v++){x=x[w[v]]}}h=x;if(t.pagination.active&&!t.api.pagination){h=h.slice(i,i+p)}if(h.length===0||e.length===0){m=true;o.message(false);o.message(true)}else{m=false;o.message(false)}o.build(h)}else{o.message(false);o.message(true)}if(u){q=t.pagination.pages;p=t.pagination.count}}).fail(function(v,w){}).always(function(){o.loader(false);setTimeout(function(){f=false},800);t.afterLoad(e,o)})}};o.build=function(u){if(typeof u!=="object"){o.debug("invalidJSON","error","The response must be a valid JSON object.");if(typeof u==="string"){c(o.append("<p>"+u+"</p>"))}}else{if(t.debug){o.debug("response","notice",u)}c.each(u,function(x,w){k=w;var z=s.clone(),y=o.parseObj(z.html(),w);z.html(y).addClass("lazyjson-template").appendTo(o);if(t.effect!==null){z.hide();setTimeout(function(){if(t.effect==="fadeIn"){z.fadeIn("fast")}else{if(t.effect==="slideDown"){z.slideDown("fast")}}},t.delay*x)}})}};o.extractVal=function(w,u){if(typeof w!=="undefined"){if(u.indexOf(".")!==-1){var v=u.split(".")[0],u=u.slice(v.length+1,u.length);return o.extractVal(w[v],u)}else{if(w!==null&&typeof w[u]!=="undefined"){return w[u]}else{return false}}return false}};o.parseFlag=function(z){var E=z.split(" "),u=E[0].indexOf("::")!==-1?E[0].split("::")[0].replace(/[{{|}}]/gm,""):null,B=u?E[0].split("::")[1].replace(/[{{|}}]/gm,""):z.split(" ")[0].replace(/[{{|}}]/gm,""),A=(!u||u===t.flagspace)?o.extractVal(k,B):null,w=z.match(/(\w+)(?=\=)|\s*?[\"\']([^\"\']+)[\"\']/gm)||[],C={};for(var x=0;x<=w.length-2;x++){C[w[x]]=w[x+1].replace(/['"]/gm,"");x++}if(C.ifVal&&C.ifVal.indexOf(A)!==-1){var v=C.ifVal.split(",");for(var x=0;x<v.length;x++){var y=v[x].split("::");if(A==y[0]){return y[1]}}}else{if(C.exists&&A!==false){return C.exists}else{if(C.empty&&(A===false||A===null)){return C.empty}else{if(C.callback&&typeof b[C.callback]==="function"){var D=b[C.callback];return D(A)}else{return A===0?"0":A||""}}}}};o.parseObj=function(u,v){if(typeof v==="object"){u=u.replace(/\{\{\s*(\w[^\}\s]*)(.*?)\s*\}\}/gm,o.parseFlag)}else{if(typeof v==="string"){u=u.replace(/\{\{value\}\}/gm,v)}}return u};o.destroy=function(){c.each(d,function(w,u){c(u.targ).off(u.evt)})};o.getDataType=function(){var v=document.createElement("a"),u=document.createElement("a");v.href=document.URL;u.href=t.api.uri;if(u.hostname===v.hostname&&!t.api.forceJSONP){return"json"}else{return"jsonp"}};o.loader=function(u){if(u){o.append(t.loader)}else{c(t.loader,o).remove()}};o.message=function(u){if(u){o.append(t.noResults)}else{c(t.noResults,o).remove()}};if(c(this).length!==0){o.init();o.debug("options","notice",t)}else{o.debug("invalidMainElement","error","The main object "+this+" does not exist.")}return this.each(function(){var u=c(this)})};c.fn.lazyjson.defaults={loadOnInit:true,templatePrefix:"template-",flagspace:null,loader:'<div class="lj-loader" style="text-align:center;padding:20px;"><img /></div>',loaderImg:null,noResults:'<div class="lj-noresponse" style="text-align:center;margin:10px 0;padding:20px;"></div>',noResultsText:"No Results Found",delay:50,effect:null,pagination:{active:false,pages:1,count:10,appendResults:false,lazyLoad:false,nextBtn:"a.next",prevBtn:"a.previous",loadOnEvent:null,loadOnTarget:null},api:{uri:null,httpMethod:"GET",forceJSONP:false,dataPos:false,pagination:false,pagVars:false,whichPagVars:null,pagesKey:"page",limitKey:"limit",offsetKey:"offset",params:{}},debug:false,afterLoad:function(d){}}})(window,console,jQuery);